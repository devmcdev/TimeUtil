@page "/"

@inject ISnackbar Snackbar
@inject IOutlookCalendarCSVParseService Parser

@using Microsoft.AspNetCore.Components.Forms
@using TimeUtil.Shared
@using TimeUtil.Shared.Interfaces

<PageTitle>Time Utilisation</PageTitle>

<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="pa-3">
            @if (cal is null)
            {
                <InputForm OnSubmit="@HandleSubmit" />
            }
            else
            {
                <MudText Typo="Typo.subtitle1">
                    File: <strong>@_file!.Name</strong> is currently being displayed
                    <MudButton Variant="Variant.Filled"
                           Color="Color.Info"
                           StartIcon="@Icons.Filled.RestartAlt"
                           Class="ml-2"
                           Size="Size.Small"
                           OnClick="Reset">
                        Reset
                    </MudButton>
                </MudText>
            }
        </MudPaper>

    </MudItem>
    <MudItem xs="12">
        @if (processing)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
        }
        else if (cal is not null)
        {
            <DataOutputView Calendar="@cal" />
        }
    </MudItem>
</MudGrid>



@code {
    private OutlookCalendar? cal;

    private bool processing;
    private IBrowserFile? _file;

    private async Task HandleSubmit(InputFormSubmitArgs input)
    {
        if (_file != input.File)
        {
            try
            {
                _file = input.File;
                processing = true;
                await using Stream stream = input.File.OpenReadStream(input.File.Size);
                using StreamContent streamContent = new(stream);
                cal = await Parser.OutlookCalendar(await streamContent.ReadAsStreamAsync());
            }
            catch
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
                Snackbar.Add("There was an error when processing the CSV file. Please try a differnt file", Severity.Error);
                Reset();
            }
            finally
            {
                processing = false;
            }
        }
    }


    private void Reset()
    {
        cal = null;
        _file = null;
    }

}