@using TimeUtil.Shared

<MudTable AllowUnsorted="false" Striped="true" Dense="true" RowsPerPage="25" Items="@Events.Events" Hover="true" Breakpoint="Breakpoint.Sm" Filter="FilterEvents">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Events</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="filterString" Placeholder="Search Event Subject" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Event, object?>(x=> x.EventSubject)">
                Event Subject
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel InitialDirection="SortDirection.Ascending"
                               SortBy="new Func<Event, object>(x=> x.FullStartDateTime)">
                Start Date
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Event, object>(x=> x.FullEndDateTime)">
                End Date
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Event, object>(x=> x.Eventduration)">
                Event duration
            </MudTableSortLabel>
        </MudTh>
        <MudTh>Event Categories</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Event Subject">@context.EventSubject</MudTd>
        <MudTd DataLabel="Start Date">@context.StartDate | @context.StartTime</MudTd>
        <MudTd DataLabel="End Date">@context.EndDate | @context.EndTime</MudTd>
        <MudTd DataLabel="Event duration">@context.Eventduration</MudTd>
        <MudTd DataLabel="Event Categories">
            <ul>
                @foreach (string category in context.Categories)
                {
                    <li @key="category">
                        @category
                    </li>
                }
            </ul>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    [Parameter, EditorRequired] public EventsTableData Events { get; set; } = default!;

    private string filterString = string.Empty;

    private EventsTableData? _prevEvents;
    private bool _shouldRender = true;


    private bool FilterEvents(Event calEvent)
    {
        if (string.IsNullOrWhiteSpace(filterString))
        {
            return true;
        }
        if (calEvent.EventSubject is not null && calEvent.EventSubject.Contains(filterString, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }
        return false;
    }

    protected override void OnParametersSet()
    {
        ThrowHelpers.ThrowIfRequiredPrameterNull(Events);

        if (_prevEvents != Events)
        {
            _prevEvents = Events;
        }
        else
        {
            _shouldRender = false;
        }
    }

    protected override bool ShouldRender()
    {
        bool tempShouldRender = _shouldRender;

        _shouldRender = true;

        return tempShouldRender;
    }
}
